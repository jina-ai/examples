# JINA 100è¡Œä»£ç æ­å»ºä¸€å¥—ä¸­æ–‡é—®ç­”ç¥ç»ç½‘ç»œæœç´¢å¼•æ“

Â Â Â Â ä¸€æåˆ°æœç´¢å¼•æ“ï¼Œå¤§å®¶å¯èƒ½ä¼šæƒ³åˆ°å®ç°**å›°éš¾ï¼Œç³»ç»Ÿå¤æ‚ã€è‡ƒè‚¿**ã€‚ä½†æ˜¯ç°åœ¨æœ‰ä¸€ä¸ª**é­”æ³•å™¨**ï¼Œ**å®ƒå¯ä»¥è®©æˆ‘ä»¬ä¸“æ³¨äºä¸šåŠ¡æœ¬èº«ï¼Œä»¥æœ€å¿«çš„æ—¶é—´å®ç°ä¸€å¥—**ç¥ç»ç½‘ç»œæœç´¢å¼•æ“ã€‚

Â Â Â Â é‚£è¿™ä¸ªé­”æ³•å™¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå®ƒå°±æ˜¯**jina**ï¼›é‚£jinaæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿjinaæ˜¯ä¸€ä¸ª**å¼€æºç¥ç»æœç´¢å¼•æ“æ¡†æ¶**ï¼Œå®ƒæœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿ**æ˜“ä¸Šæ‰‹**ã€**åˆ†å¸ƒå¼**ã€**æ¨¡å‹å®¹å™¨åŒ–**ã€**å¼¹æ€§æ‰©å±•**å’Œ**äº‘åŸç”Ÿ**ã€‚

Â Â Â Â è®²åˆ°è¿™ï¼Œæœ‰æ²¡æœ‰è§‰å¾—å¾ˆæœ‰è¶£å‘¢ï¼Ÿæƒ³é©¬ä¸Šåˆ©ç”¨jinaæ­å»ºä¸€å¥—è‡ªå·±çš„æœç´¢å¼•æ“å‘¢ï¼Ÿ

Â Â Â Â å¥½ï¼Œä»Šå¤©æˆ‘ä»¬å°±ç”¨å°‘äº100è¡Œçš„Pythonä»£ç æ­å»ºä¸€å¥—WebQAæœç´¢ç³»ç»Ÿã€‚åœ¨è¿™ä¸ªç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬é‡‡ç”¨WebQAä½œä¸ºæˆ‘ä»¬çš„æ•°æ®é›†ï¼ŒÂ æ•°æ®é›†å«æœ‰410ä¸‡ä¸ªé¢„å…ˆè¿‡æ»¤è¿‡çš„ã€é«˜è´¨é‡é—®é¢˜å’Œå¤šä¸ªå›å¤ï¼Œæ•°æ®é›†ä¸‹è½½[åœ°å€](https://drive.google.com/open?id=1u2yW_XohbYL2YAK6Bzc5XrngHstQTf0v)ã€‚æˆ‘ä»¬å°†æ¯ä¸ªé—®é¢˜å’Œé—®é¢˜ä¸‹çš„å›å¤å½“æˆä¸€ä¸ª**æ–‡æ¡£**ï¼Œæ¯ä¸ªé—®é¢˜å½“æˆä¸€ä¸ª**chunk**ï¼Œå¦‚æœä½ ä¸æ˜¯å¾ˆç†Ÿæ‚‰è¿™äº›æ¦‚å¿µï¼Œåœ¨ç»§ç»­é˜…è¯»ä¹‹å‰ï¼Œå¼ºçƒˆå»ºè®®ä½ é˜…è¯»[Jina 101](https://github.com/jina-ai/jina/tree/master/docs/chapters/101)å’Œ[Jina "Hello, World!"ğŸ‘‹](https://github.com/jina-ai/jina#jina-hello-world-)ã€‚

## å¯¼è¯»

- [æ•ˆæœå±•ç¤º](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E6%95%88%E6%9E%9C%E5%B1%95%E7%A4%BA)
- [æ€»è§ˆ](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E6%80%BB%E8%A7%88)
- [ç¯å¢ƒä¾èµ–](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E7%8E%AF%E5%A2%83%E4%BE%9D%E8%B5%96)
- [æ•°æ®é¢„å¤„ç†](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E6%95%B0%E6%8D%AE%E9%A2%84%E5%A4%84%E7%90%86)
- [å®šä¹‰Flow](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E5%AE%9A%E4%B9%89flow)
- [å°ç»“](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E5%B0%8F%E7%BB%93)
- [è¿è¡ŒFlow](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E8%BF%90%E8%A1%8Cflow)
- [æ·±å…¥Pod](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E6%B7%B1%E5%85%A5pod)
- [å®¹å™¨åŒ–](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E5%AE%B9%E5%99%A8%E5%8C%96)
- [åˆ†å¸ƒå¼](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E5%88%86%E5%B8%83%E5%BC%8F)
- [å›é¡¾](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E5%9B%9E%E9%A1%BE)
- [ç»“è¯­](https://github.com/jina-ai/examples/tree/webqa-search/webqa-search#%E7%BB%93%E8%AF%AD)

## æ•ˆæœå±•ç¤º

![](.github/result.gif)

## æ€»è§ˆ

Â Â Â Â ä¸ä¼ ç»Ÿçš„æœç´¢å¼•æ“ä¸€æ ·ï¼Œåˆ†ä¸ºåˆ›å»ºç´¢å¼•å’Œæœç´¢ä¸¤ä¸ªéƒ¨åˆ†ã€‚

Â Â Â Â åœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆä¼šä¸ºæ‰€æœ‰çš„æ–‡æ¡£å»ºç«‹ç´¢å¼•ï¼Œåˆ©ç”¨`transformes`åŠ è½½å“ˆå·¥å¤§`Roberta`ä½œä¸ºç¼–ç å™¨ï¼Œå°†chunkä¸­çš„æ–‡æœ¬ç¼–ç æˆå‘é‡ï¼Œå¹¶è¿›è¡Œå­˜å‚¨ï¼›åœ¨æœç´¢æ—¶ï¼Œç”¨æˆ·è¾“å…¥é—®é¢˜ï¼Œç¼–ç å™¨å°†é—®é¢˜ç¼–ç æˆå‘é‡ï¼Œç„¶ååˆ©ç”¨è¿™äº›å‘é‡å»å¬å›æœ€ç›¸ä¼¼çš„é—®é¢˜ï¼Œå†åˆ©ç”¨é—®é¢˜è¿”å›é—®é¢˜ä¸‹çš„å›å¤ã€‚



## ç¯å¢ƒä¾èµ–

Â Â Â Â è¿™ä¸ªdemoè¿è¡Œåœ¨Python3.7ä»¥ä¸Šçš„ç¯å¢ƒ

```shell
pip install -r requirements.txt
```



## æ•°æ®é¢„å¤„ç†

Â Â Â Â åœ¨ä¸‹è½½å¥½æ•°æ®é›†ä»¥åï¼Œæˆ‘ä»¬å°†æ•°æ®é›†æ”¾åˆ°`/tmp`æ–‡ä»¶å¤¹ä¸­ï¼Œè¿è¡Œä¸‹é¢å‘½ä»¤ã€‚

```shell
python pre_data.py
```



## å®šä¹‰Flow

### åˆ›å»ºç´¢å¼•

Â Â Â Â åœ¨åˆ›å»ºç´¢å¼•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡YAMLæ–‡ä»¶å®šä¹‰Flowã€‚åœ¨Flowä¸­æˆ‘ä»¬å®šä¹‰äº†`extractor`ï¼Œ`doc_indexer`, `encoder`, `chunk_indexer`, `join`è¿™5ä¸ªPodã€‚

<table style="margin-left:auto;margin-right:auto;">
<tr>
<td> flow-index.yml</td>
<td> Flow in Dashboard</td>
</tr>
<tr>
<td>
  <sub>

```yaml
!Flow
pods:
  doc_indexer:
    yaml_path: doc_indexer.yml

  extractor:
    yaml_path: extractor.yml
    needs: gateway

  encoder:
    yaml_path: encoder.yml
    timeout_ready: 60000

  chunk_indexer:
    yaml_path: chunk_indexer.yml

  join:
    yaml_path: merger
    needs: [doc_indexer, chunk_indexer]
```

</sub>

</td>
<td>
<img align="right" height="420px" src=".github/index.png"/>
</td>
</tr>
</table>

> gateway

Â Â Â Â åœ¨è¿™é‡Œä½ å¯èƒ½ä¼šå‘ç°è¿˜å­˜åœ¨`gateway`è¿™ä¸ªPodï¼Œè¿™ä¸ªPodçš„ä¸»è¦ä½œç”¨æ˜¯æ¥å—å¤–éƒ¨çš„è¯·æ±‚ï¼Œå¹¶å°†è¯·æ±‚çš„æ•°æ®å‘é€åˆ°Flowä¸­çš„Podä¸­ï¼›å¹¶ä¸”`gateway`è¿™ä¸ªPodä¸éœ€è¦æˆ‘ä»¬åœ¨Flowçš„yamlæ–‡ä»¶ä¸­å®šä¹‰ï¼Œåœ¨è¿è¡Œæ—¶ï¼Œjinaä¼šè‡ªåŠ¨åœ¨Flowçš„å¼€å¤´å®šä¹‰è¿™ä¸ªPodã€‚

> extractor

Â Â Â Â å°†æ–‡æ¡£çº§åˆ«ä¿¡æ¯åˆ†å‰²ä¸ºchunkçº§åˆ«çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æå‡ºæ–‡æ¡£ä¸­çš„é—®é¢˜ã€‚

> doc_indexer

Â Â Â Â å­˜å‚¨é—®é¢˜å’Œå›å¤æ•´ä¸ªæ–‡æ¡£ã€‚

> encoder

Â Â Â Â å°†chunkä¸­çš„æ–‡æœ¬ç¼–ç æˆå‘é‡ï¼Œç­‰ä»·äºå°†é—®é¢˜ç¼–ç æˆå‘é‡ã€‚

> chunk_indexer

Â Â Â Â å­˜å‚¨chunkä¸æ–‡æ¡£çš„å…³è”å…³ç³»ï¼Œè¿˜å­˜å‚¨äº†ç¼–ç åçš„å‘é‡ã€‚

Â Â Â Â 

Â Â Â Â åœ¨Flowä¸­å®šä¹‰Podæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®šPodçš„YAMLæ–‡ä»¶åœ°å€å’Œæ¥å—å“ªä¸ªPodçš„è¯·æ±‚ï¼Œä¾‹å¦‚åœ¨`extractor`è¿™ä¸ªPodä¸­ï¼Œæˆ‘ä»¬å®šä¹‰Podçš„yamlæ–‡ä»¶åœ°å€ä¸º`extractor.yml`ï¼Œæ¥å—æ¥è‡ª`gateway`çš„è¯·æ±‚ã€‚

```yaml
extractor:
    yaml_path: extractor.yml
    needs: gateway
```

Â Â Â Â ä¸¤ä¸ªPodåœ¨YAMLæ–‡ä»¶ä¸­çš„é¡ºåºæ˜¯ä¾æ¬¡çš„ï¼Œåˆ™ä¸éœ€è¦å®šä¹‰needsï¼Œä¾‹å¦‚åœ¨`chunk_indexer`è¿™ä¸ªPodã€‚

```yaml
chunk_indexer:
    yaml_path: chunk_indexer.yml
```

Â Â Â Â å¦‚æœä¸€ä¸ªPodåŠ è½½è€—æ—¶å¾ˆé•¿ï¼Œè€Œåœ¨jinaä¸­Podçš„é»˜è®¤åŠ è½½æ—¶é—´ä¸º5sï¼Œæˆ‘ä»¬åˆ™éœ€è¦æŒ‡å®š`timeout_ready`è¿™ä¸ªå‚æ•°ï¼Œä¾‹å¦‚åœ¨`encoder`è¿™ä¸ªPodã€‚

```yaml
encoder:
  yaml_path: encode.yml
  timeout_ready: 60000
```

Â Â Â Â ä½ å¯èƒ½è¿˜æ³¨æ„åˆ°åœ¨ä»‹ç»Podçš„åŠŸèƒ½æ—¶ï¼Œæ²¡æœ‰`join`è¿™ä¸ªPodã€‚åœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤æ¡å¹¶è¡Œçš„æµï¼Œæ‰€ä»¥`join`çš„ä½œç”¨æ˜¯åˆå¹¶ä¸¤æ¡å¹¶è¡Œæµä¸­çš„æ‰€æœ‰ä¿¡æ¯ï¼Œæˆ–è€…ä½ ä¹Ÿå¯ä»¥ç†è§£æˆç­‰å¾…ä¸¤ä¸ªæµå®Œæˆå·¥ä½œï¼Œå¹¶æ‰§è¡Œä¸‹é¢çš„ä»»åŠ¡ã€‚å½“å¦‚æœå­˜åœ¨å¤šä¸ªå¹¶è¡Œæµæ—¶ï¼Œåªéœ€è¦åœ¨`needs`ä¸­å¢åŠ ç›¸åº”çš„Podå³å¯ã€‚

```yaml
join:
  yaml_path: join
  needs: [doc_indexer, chunk_indexer]
```

### æŸ¥è¯¢

Â Â Â Â å½“å»ºç«‹å®Œæˆç´¢å¼•åï¼Œä¸‹ä¸€æ­¥æˆ‘ä»¬å°±æ˜¯ä½¿ç”¨å»ºç«‹çš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚

Â Â Â Â åŒæ ·ï¼Œåœ¨æŸ¥è¯¢æ—¶ï¼Œæˆ‘ä»¬åˆ©ç”¨YAMLæ–‡ä»¶å®šä¹‰æŸ¥è¯¢çš„Flowï¼åœ¨æŸ¥è¯¢çš„Flowä¸­ï¼Œæˆ‘ä»¬å…±ç”¨`extractor`åˆ†å‰²æ–‡æ¡£ï¼Œå…±ç”¨`encoder`ç¼–ç ç”¨æˆ·è¾“å…¥çš„é—®é¢˜ï¼Œåˆ©ç”¨`chunk_indexer`å­˜å‚¨çš„ç´¢å¼•å¬å›ç›¸ä¼¼çš„é—®é¢˜ã€‚

Â Â Â Â 

<table style="margin-left:auto;margin-right:auto;">
<tr>
<td> flow-query.yml</td>
<td> Flow in Dashboard</td>
</tr>
<tr>
<td>
  <sub>

```yaml
!Flow
pods:
  extractor:
    yaml_path: extractor.yml

  encoder:
    yaml_path: encoder.yml
    timeout_ready: 60000

  chunk_indexer:
    yaml_path: chunk_indexer.yml

  ranker:
    yaml_path: ranker.yml

  doc_indexer:
    yaml_path: doc_indexer.yml
```

</sub>

</td>
<td>
<img align="right" height="420px" src=".github/query.png"/>
</td>
</tr>
</table>
Â Â Â Â ä¸è¦å¿˜è®°åœ¨jinaä¸­ï¼Œ**chunkæ˜¯æœ€åŸºæœ¬çš„ä¿¡æ¯å•å…ƒ**ã€‚æ‰€ä»¥æ‰€æœ‰çš„ç´¢å¼•éƒ½æ˜¯åœ¨chunkçº§åˆ«è¿›è¡Œçš„ã€‚

Â Â Â Â åœ¨ç´¢å¼•ä¹‹åå†åˆ©ç”¨`ranker`å¯¹æ–‡æ¡£ä¸‹æ‰€æœ‰chunkçš„topkè¿›è¡Œæ’åºï¼Œå¹¶è¿”å›æ–‡æ¡£çº§åˆ«çš„ä¿¡æ¯ï¼Œåœ¨`ranker`ä¸­æˆ‘ä»¬é‡‡ç”¨`bi-match`ç®—æ³•è¿›è¡Œæ’åºï¼Œå…·ä½“å®ç°ç»†èŠ‚è§[github]()ã€‚

Â Â Â Â åœ¨æœ‰æ–‡æ¡£çš„ä¿¡æ¯ä¹‹åï¼Œä¸‹ä¸€æ­¥å°±æ˜¯åˆ©ç”¨`doc_indexer`å°†æ–‡æ¡£ä¿¡æ¯æ˜ å°„åˆ°æ–‡æ¡£åŸæ•°æ®ï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚Â 

Â Â Â Â åœ¨ä¸Šé¢ä½ å¯èƒ½å‘ç°`extractor`, `encoder`, `chunk_indexer`, `doc_indexer`çš„yamlæ–‡ä»¶åœ°å€ä¸åˆ›å»ºç´¢å¼•æ—¶ä¸€æ ·ï¼Œæ²¡é”™ï¼Œå®ƒä»¬å…±ç”¨åŒä¸€ä¸ªYAMLæ–‡ä»¶ï¼Œå…±åŒä¸€ä¸ªPodï¼Œåªæ˜¯åœ¨å†…éƒ¨å®šä¹‰ä¸åŒçš„è¯·æ±‚ä¸‹çš„å¤„ç†é€»è¾‘ã€‚

## å°ç»“

Â Â Â Â åœ¨å¼€å§‹ä¸‹é¢ä¹‹å‰ï¼Œæˆ‘ä»¬å›è¿‡å¤´æ¥çœ‹çœ‹ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¾ˆç®€å•ã€‚é‚£ä½ å¯èƒ½ä¼šé—®ä¸¤æ¡Flowæœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ

Â Â Â Â ç¬¬ä¸€ä¸ªä¸åŒç‚¹æ˜¯ï¼Œåœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸¤æ¡å¹¶è¡Œçš„æµï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·åšå‘¢ï¼Ÿå¹¶è¡Œçš„æµå¯ä»¥æé«˜åˆ›å»ºç´¢å¼•çš„é€Ÿåº¦ï¼Œä¸ºä»€ä¹ˆå¯ä»¥å¹¶è¡Œå‘¢ï¼Ÿåœ¨å»ºç«‹ç´¢å¼•æ—¶ï¼Œæ–‡æ¡£å­˜å‚¨çš„æ˜¯æ–‡æ¡£çº§åˆ«çš„ç´¢å¼•ï¼Œè€Œchunkç´¢å¼•æ˜¯å­˜å‚¨chunkçº§åˆ«çš„ç´¢å¼•ï¼Œåœ¨`gateway`ä»¥åï¼Œæ²¡æœ‰ä»»ä½•å…±ç”¨çš„ä¸œè¥¿ã€‚ 

Â Â Â Â ç¬¬äºŒä¸ªä¸åŒç‚¹ï¼Œåœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼ŒFlowä¸­çš„æ¨¡æ€ä¸º`IndexRequest`ï¼›åœ¨æŸ¥è¯¢æ—¶ï¼ŒFlowä¸­çš„æ¨¡æ€ä¸º`SearchRequest`ï¼›åˆ°ç›®å‰ä¸ºæ­¢ï¼Œjinaæ”¯æŒ4ä¸­ä¸åŒçš„æŸ¥è¯¢æ¨¡æ€ã€‚

- `IndexRequest`: ç”¨äºç´¢å¼•åˆ›å»ºæ¨¡æ€

- `SearchRequest`: ç”¨äºæŸ¥è¯¢æ¨¡æ€

- `TrainRequest`: ç”¨äºæ¨¡å‹è®­ç»ƒæ¨¡æ€

- `ControlRequest`: ç”¨äºè¿œç¨‹æ§åˆ¶æ¨¡æ€

## è¿è¡ŒFlow

### åˆ›å»ºç´¢å¼•

```python
python app.py -t index
```

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹æ—¥å¿—è¾“å‡º</summary>

<p align="center">
  <img src=".github/index-log.gif?raw=true" alt="æ—¥å¿—è¾“å‡º">
</p>

</details>

Â Â Â Â ç°åœ¨æˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç è®©è¿™ä¸ªFlowè·‘èµ·æ¥äº†ï¼Œåœ¨åˆ›å»ºç´¢å¼•çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å®šä¹‰Flowå’Œ`flow-index.yml`çš„æ–‡ä»¶åœ°å€ï¼Œåœ¨è¿™ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡`build()`è®©Flowä¸­çš„Podå½¼æ­¤è¿æ¥ï¼Œç„¶åé€šè¿‡`index()`å‘é€`IndexRequest`å’Œæ•°æ®ã€‚

```python
flow = Flow().load_config('flow-index.yml')
with flow.build() as fl:
    fl.index(raw_bytes=read_data(data_fn), batch_size=32)
```

Â Â Â Â åœ¨å‘é€æ•°æ®ä¸­æˆ‘ä»¬å…ˆå°†jsonæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ ·æœ¬ç»„åˆæˆä¸€é—®å¤šç­”çš„å½¢å¼ï¼Œç„¶åé€šè¿‡`bytes`æ•°æ®çš„å½¢å¼å‘é€åˆ°Flowä¸­ã€‚

```python
def read_data(fn):
    items = {}
    with open(fn, 'r', encoding='utf-8') as f:
        for line in f:
            item = json.loads(line)
            if item['content'] == '':
                continue
            if item['qid'] not in items.keys():
                items[item['qid']] = {}
                items[item['qid']]['title'] = item['title']
                items[item['qid']]['answers'] = [{'content': item['content']}]
            else:
                items[item['qid']]['answers'].append({'content': item['content']})

    result = []
    for _, value in items.items():
        result.append(("{}".format(json.dumps(value, ensure_ascii=False))).encode("utf-8"))

    for item in result:
        yield item
```

### æŸ¥è¯¢

```python
python app.py -t query
```

<details>
<summary>ç‚¹å‡»æŸ¥çœ‹æ—¥å¿—è¾“å‡º</summary>

<p align="center">
  <img src=".github/query-log.gif?raw=true" alt="æ—¥å¿—è¾“å‡º">
</p>

</details>

Â Â Â Â åœ¨æŸ¥è¯¢æ—¶åˆ»ï¼Œæˆ‘ä»¬åŒæ ·ä»YAMLæ–‡ä»¶ä¸­å»ºç«‹Flowï¼Œé€šè¿‡`search()`æ–¹æ³•å‘é€`SearchRequest`è¯·æ±‚å’Œæ•°æ®ï¼Œå¹¶ä¸”å‘é€çš„æ•°æ®åŒæ ·ä¼šè¢«è½¬æ¢ä¸º`bytes`çš„æ•°æ®å½¢å¼ã€‚

```python
flow = Flow().load_config('flow-query.yml')
with flow.build() as fl:
    while True:
        title = input('è¯·è¾“å…¥é—®é¢˜: ')
        item = {'title': title}
        if not title:
            break
        ppr = lambda x: print_topk(x)
        fl.search(read_query_data(item), callback=ppr, topk=top_k)
```

Â Â Â Â åœ¨æŸ¥è¯¢å®Œæˆä»¥åï¼ŒFLowè¿”å›çš„æ•°æ®å½¢å¼ä¸º`Protobuf`ï¼Œå¦‚æœä½ å¸Œæœ›äº†è§£è¯¦ç»†çš„`Protobuf`æ•°æ®ï¼Œå¯ä»¥å‚è€ƒ[é“¾æ¥](https://github.com/jina-ai/jina/blob/master/jina/proto/jina.proto)ã€‚callbackå‚æ•°çš„ä½œç”¨æ˜¯å°†`Protobuf`è½¬æ¢ä¸º`python`çš„æ•°æ®å½¢å¼ã€‚`resp.search.docs`åŒ…å«äº†æ‰€æœ‰çš„æœç´¢æ–‡æ¡£ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæœ‰ä¸€ä¸ªæ–‡æ¡£ï¼Œæ–‡æ¡£ä¸­åŒ…å«äº†topkçš„æœç´¢ç»“æœæ–‡æ¡£ï¼Œ`raw_bytes`ä»£è¡¨äº†æ–‡æ¡£çš„åŸæ•°æ®ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¸ºäº†å±•ç¤ºæ•ˆæœï¼Œåªå±•ç¤ºäº†é—®é¢˜ï¼Œæ²¡æœ‰å±•ç¤ºé—®é¢˜ä¸‹çš„å›å¤ã€‚

```python
def print_topk(resp):
    print(f'ä»¥ä¸‹æ˜¯ç›¸ä¼¼çš„é—®é¢˜:')
    for d in resp.search.docs:
        for tk in d.topk_results:
            item = json.loads(tk.match_doc.raw_bytes.decode('utf-8'))
            print('â†’%s' % item['title'])
```

## æ·±å…¥Pod

Â Â Â Â åœ¨é˜…è¯»å®Œä¸Šé¢ä¹‹åï¼Œä½ å¸Œæœ›äº†è§£å…³äºPodçš„æ›´å¤šå†…å®¹ï¼Œè¯·ç»§ç»­å¾€ä¸‹é˜…è¯»ã€‚

Â Â Â Â åœ¨jinaä¸­æˆ‘ä»¬é€šè¿‡å®šä¹‰YAMLæ–‡ä»¶å®šä¹‰Podï¼Œé‚£ä¹ˆæ˜¯å¦‚ä½•é€šè¿‡YAMLæ–‡ä»¶å®šä¹‰Podçš„å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­å¾€ä¸‹èµ°ã€‚

### extractor

Â Â Â Â åœ¨jinaçš„åŸåˆ™ä¸­ï¼Œä¸€ä¸ªYAMLæ–‡ä»¶æè¿°äº†ä¸€ä¸ªå¯¹è±¡çš„å±æ€§ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡YAMLå»æ”¹å˜å¯¹è±¡çš„å±æ€§ï¼Œè€Œä¸å¿…å»æ”¹åŠ¨ä»£ç ã€‚

Â Â Â Â åœ¨`extractor`ä¸­ï¼Œå®ƒçš„ä¸»è¦ä½œç”¨æ˜¯å°†æ–‡æ¡£ä¸­çš„é—®é¢˜å–å‡ºæ¥ï¼Œå³å°†æ–‡æ¡£çº§åˆ«çš„ä¿¡æ¯åˆ†å‰²æˆchunkçº§åˆ«çš„ä¿¡æ¯ã€‚ä¸‹é¢æ˜¯`extractor`çš„YAMLæ–‡ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡ç»§æ‰¿äº†`BaseSegmenter`å®ç°äº†`WebQATitleExtractor`ä½œä¸º`extractor`çš„Executorï¼Œé€šè¿‡å®šä¹‰`metas`ä¿®æ”¹äº†Executorçš„é»˜è®¤å±æ€§ã€‚

```yaml
!WebQATitleExtractor
metas:
  py_modules: extractor.py
  workspace: $TMP_WORKSPACE
  name: title_extractor
requests:
  on:
    [IndexRequest, SearchRequest]:
      - !SegmentDriver
        with:
          method: craft
```
```python
class WebQATitleExtractor(BaseSegmenter):
    def craft(self, doc_id, raw_bytes, *args, **kwargs):
        json_dict = json.loads(raw_bytes.decode('utf-8'))
        title = json_dict['title']
        return [{
                    'raw_bytes': title.encode('utf-8'),
                    'doc_id': doc_id,
                    'offset': 0,
                    'length': len(title),
                    'text': title
                }]
```

Â Â Â Â åœ¨`requests on`éƒ¨åˆ†ï¼Œæˆ‘ä»¬å®šä¹‰äº†`extractor`åœ¨å¤„ç†ä¸åŒè¯·æ±‚æ—¶çš„é€»è¾‘ï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­`extractor`åœ¨`IndexRequest`å’Œ`SearchRequest`æ—¶éƒ½æ˜¯ç›¸åŒçš„è¡Œä¸ºï¼Œè¿™å°±æ˜¯å…¬ç”¨Podçš„åŸç†ã€‚

Â Â Â Â åœ¨jinaä¸­Driveræ˜¯ä¸€ä¸ªæ•°æ®ç±»å‹è½¬æ¢å™¨ï¼Œå°†ProtoBufè½¬æ¢ä¸º`python`æ•°æ®ç±»å‹/ `numpy`æ•°æ®ç±»å‹ï¼Œæˆ–å°†`python`æ•°æ®ç±»å‹/ `numpy`æ•°æ®ç±»å‹è½¬æ¢ä¸ºProtoBufï¼Œåœ¨è¿™ä¸ªä¾‹å­ä¸­`SegmentDriver`å°†ProtoBufè½¬æ¢ä¸ºPython Object / Numpy Objectï¼Œå¹¶è°ƒç”¨`WebQATitleExtractor`ä¸­çš„`craft()`ï¼Œåœ¨`craft()`å¤„ç†å®Œæ•°æ®ä»¥åï¼Œ`SegmentDriver`å°†Python Object / Numpy Objectè½¬æ¢ä¸ºProtoBufã€‚

### encoder

Â Â Â Â æˆ‘ä»¬åœ¨`extractor`å·²ç»é—®é¢˜ä»æ–‡æ¡£ä¸­æå–äº†å‡ºæ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸‹é¢éœ€è¦åšçš„æ˜¯å°†é—®é¢˜ç¼–ç æˆå‘é‡ã€‚

Â Â Â Â åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å“ˆå·¥å¤§-ç§‘å¤§è®¯é£çš„`Roberta base wwm ext`æ¨¡å‹ä½œä¸ºç¼–ç å™¨æ¨¡å‹ï¼Œé€šè¿‡ç»§æ‰¿`BaseTextEncoder`å®ç°äº†`TransformerRobertaEncoder`ä½œä¸ºæˆ‘ä»¬çš„ç¼–ç å™¨ï¼Œå¹¶ä¸”ä½¿ç”¨`transformers`åŠ è½½æ¨¡å‹ï¼Œä½¿ç”¨`CLS`ä½œä¸ºæ–‡æœ¬å‘é‡ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡å®šä¹‰`with`æ¥ä¿®æ”¹`__init__`æ–¹æ³•ä¸­å‚æ•°çš„å€¼ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹äº†æ¨¡å‹çš„è·¯å¾„ã€‚è¯¦ç»†ä»£ç è§[é“¾æ¥]()ã€‚

```yaml
!TransformerRobertaEncoder
metas:
  workspace: $TMP_WORKSPACE
  name: transformer_roberta_encoder
  py_modules: transformer_roberta.py

with:
  model_path: /home/cally/jina/jina/pre_model/chinese_roberta_wwm_ext

requests:
  on:
    [SearchRequest, IndexRequest]:
      - !EncodeDriver
        with:
          method: encode
```

### doc_indexer

Â Â Â Â ä¸ä¸Šé¢`extractor`å’Œ`encoder`å¤„ç†è¯·æ±‚æ—¶ä¸ä¸€æ ·ï¼Œ`doc_indexer`åˆ†å¼€å¤„ç†äº†`IndexRequest`å’Œ`SearchRequest`ã€‚

```yaml
!BasePbIndexer
with:
  index_filename: doc_index.gzip
metas:
  name: doc_indexer
  workspace: $TMP_WORKSPACE
requests:
  on:
    IndexRequest:
      - !DocKVIndexDriver
        with:
          method: add

    SearchRequest:
      - !DocKVSearchDriver
        with:
          method: query

    ControlRequest:
      - !ControlReqDriver {}
```

Â Â Â Â åœ¨`IndexRequest`è¯·æ±‚æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨`DocKVIndexDriver`è°ƒç”¨`BasePbIndexer`çš„`add()`å­˜å‚¨äº†æ–‡æ¡£çº§åˆ«çš„æ•°æ®ã€‚

Â Â Â Â ä½†æ˜¯åœ¨`SearchRequest`æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨`DocKVSearchDriver`è°ƒç”¨`BasePbIndexer`çš„`query()`ç´¢å¼•æ–‡æ¡£çº§åˆ«çš„æ•°æ®ã€‚

### chunk_indexer

Â Â Â Â `chunk_indexer`çš„YAMLæ–‡ä»¶æœ‰ç‚¹å¤æ‚ã€‚åˆ«ç€æ€¥ï¼Œè¿™æ˜¯æœ€ç®€å•çš„æ–¹æ³•äº†ã€‚`chunk_indexer` Podä¸­çš„Executorç§°ä¸º`ChunkIndexer`ï¼Œå®ƒå°è£…äº†å¦å¤–ä¸¤ä¸ªæ‰§è¡Œå™¨ã€‚`components`å­—æ®µæŒ‡å®šä¸¤ä¸ªåŒ…è£…å¥½çš„æ‰§è¡Œå™¨ã€‚`NumpyIndexer`ç”¨äºå­˜å‚¨é—®é¢˜çš„å‘é‡ï¼Œ`BasePbIndexer`ç”¨ä½œé”®å€¼å­˜å‚¨æ¥ä¿å­˜æ–‡æ¡£idå’Œchunk idçš„å…³è”ã€‚

```yaml
!ChunkIndexer
components:
  - !NumpyIndexer
    with:
      index_filename: vecidx_index.gzip
      metrix: cosine
    metas:
      name: vecidx_exec
      workspace: $TMP_WORKSPACE
  - !BasePbIndexer
    with:
      index_filename: chunk_index.gzip
    metas:
      name: chunk_exec
      workspace: $TMP_WORKSPACE

metas:
  name: chunk_indexer

requests:
  on:
    IndexRequest:
      - !VectorIndexDriver
        with:
          executor: vecidx_exec
          method: add
      - !ChunkPruneDriver {}
      - !ChunkKVIndexDriver
        with:
          executor: chunk_exec
          method: add
    SearchRequest:
      - !VectorSearchDriver
        with:
          executor: vecidx_exec
          method: query
      - !ChunkPruneDriver {}
      - !ChunkKVSearchDriver
        with:
          executor: chunk_exec
          method: query
```

Â Â Â Â ä¸`doc_indexer`ä¸€æ ·ï¼Œ`chunk_indexer`åœ¨ä¸åŒè¯·æ±‚æ—¶ï¼Œæœ‰ä¸åŒçš„è¡Œä¸ºã€‚

Â Â Â Â åœ¨`IndexRequest`æ—¶ï¼Œæˆ‘ä»¬å®šä¹‰äº†3ä¸ªä¸åŒçš„Driverï¼Œ`VectorIndexDriver`ï¼Œ`ChunkPruneDriver`ï¼Œ`ChunkKVIndexDriver`ï¼Œ3ä¸ªDriveræ˜¯ä¾æ¬¡æ‰§è¡Œçš„ã€‚åœ¨`VectorIndexDriver`æ—¶ï¼Œæˆ‘ä»¬è°ƒç”¨äº†`vecidx_exec`è¿™ä¸ªExecutorä¸­çš„`add()`å­˜å‚¨äº†é—®é¢˜çš„å‘é‡ï¼Œåœ¨å­˜å‚¨å®Œæˆä»¥åï¼Œæˆ‘ä»¬æ¸…ç©ºäº†chunkä¸­çš„æ•°æ®ï¼Œåªä¿ç•™chunk idå’Œæ–‡æ¡£idï¼Œå› ä¸ºåœ¨`ChunkKVIndexDriver`è°ƒç”¨`chunk_exec`ä¸­çš„`add()`å­˜å‚¨æ–‡æ¡£å’Œchunkçš„å…³è”æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿™äº›æ•°æ®ã€‚

Â Â Â Â åœ¨`SearchRequest`æ—¶ï¼Œæˆ‘ä»¬åŒæ ·å®šä¹‰äº†3ä¸ªä¸åŒçš„Driverï¼Œ`VectorSearchDriver`è°ƒç”¨äº†`vecidx_exec`ä¸­çš„`query()`ç´¢å¼•äº†topkçš„é—®é¢˜ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº†ä½™å¼¦ç›¸ä¼¼åº¦æ¥è¿›è¡Œå¬å›ï¼Œå¹¶ä¸”ä½¿ç”¨`ChunkPruneDriver`æ¸…ç©ºchunkä¸­çš„æ•°æ®ï¼Œåªä¿ç•™chunk idå’Œæ–‡æ¡£idï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åé¢ç”¨ä¸åˆ°è¿™äº›æ•°æ®ï¼Œä¹Ÿæ˜¯ä¸ºäº†å‡å°‘åœ¨ç½‘ç»œä¼ è¾“æ—¶æ•°æ®çš„å¤§å°ï¼Œæœ€åä½¿ç”¨`ChunkKVSearchDriver`è°ƒç”¨`chunk_exec`ä¸­çš„`query()`ï¼Œç´¢å¼•å‡ºtopkä¸­chunkçš„æ–‡æ¡£idã€‚

### ranker

Â Â Â Â `ranker`ä¸åŒä¸å…¶å®ƒPodï¼Œå®ƒåªåœ¨æŸ¥è¯¢æ—¶ä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦åœ¨YAMLæ–‡ä»¶ä¸­å®šä¹‰SearchRequestçš„è¡Œä¸ºã€‚

Â Â Â Â åœ¨æ¯ä¸ªæ–‡æ¡£ä¸‹çš„é—®é¢˜çš„topkç›¸ä¼¼é—®é¢˜éƒ½æ‰¾åˆ°ä»¥åï¼Œæˆ‘ä»¬åˆ©ç”¨`Chunk2DocScoreDriver`å°†æ‰€æœ‰topk chunkç»„åˆåˆ°ä¸€èµ·ï¼Œåœ¨è¿™é‡Œï¼Œæ¯ä¸ªæ–‡æ¡£ä¸‹åªæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±åªæœ‰ä¸€ä¸ªchunkã€‚ç„¶åè°ƒç”¨`BimatchRanker`ä¸­çš„`score`æ–¹æ³•å¯¹topk chunkè¿›è¡Œæ‰“åˆ†ï¼Œå¹¶æ’åºã€‚å¯¹äºæ’åºåçš„ç»“æœï¼Œ`Chunk2DocScoreDriver`å°†topk chunkæå‡ä¸ºtopkæ–‡æ¡£ã€‚Â Â Â Â 

```yaml
!BiMatchRanker
metas:
  name: ranker
requests:
  on:
    SearchRequest:
      - !Chunk2DocScoreDriver
        with:
          method: score
      - !DocPruneDriver {}
```

## å›é¡¾

Â Â Â Â æ­å–œä½ ï¼Œä½ å·²ç»äº†è§£äº†å¦‚ä½•ç”¨jinaæ­å»ºä¸€å¥—ç¥ç»ç½‘ç»œæœç´¢å¼•æ“äº†ğŸ‘‹ğŸ‘‹ã€‚

Â Â Â Â åœ¨ä½ ç¦»å¼€ä¹‹å‰æˆ‘ä»¬æ¥å›é¡¾ä¸‹åœ¨jinaä¸­æ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ã€‚

1. chunkæ˜¯jinaçš„ä¿¡æ¯å•å…ƒï¼Œæ–‡æ¡£æ˜¯jinaæœ€ç»ˆçš„è¾“å…¥å’Œè¾“å‡ºã€‚

2. é€šè¿‡å®šä¹‰YAMLæ–‡ä»¶æ„å»ºä¸€ä¸ªFlowæ˜¯éå¸¸å¿«æ·å’Œç®€å•çš„ã€‚

3. é€šè¿‡å®šä¹‰åœ¨YAMLæ–‡ä»¶ä¸­å®šä¹‰ä¸åŒçš„è¡Œä¸ºï¼Œå¾ˆå¤šPodå¯ä»¥åœ¨åˆ›å»ºç´¢å¼•å’Œæœç´¢æ—¶å…±ç”¨ï¼Œã€‚

4. Flowä¸­æˆ‘ä»¬å¯ä»¥å®šä¹‰è®¸å¤šå¹¶è¡Œçš„æµã€‚

5. å‘Flowä¸­å‘é€çš„æ•°æ®éƒ½æ˜¯`bytes`ç±»å‹çš„ã€‚

6. åœ¨Podå†…ï¼ŒDriverè½¬æ¢æ•°æ®ç±»å‹ï¼Œå°†æ¶ˆæ¯ä¸­çš„Protobufè½¬æ¢ä¸ºPythonç±»å‹/Numpyç±»å‹ï¼Œå¹¶è°ƒç”¨Executoræ‰§è¡Œç›¸å…³çš„é€»è¾‘ï¼Œå¹¶å°†ç»“æœåŒ…è£…å›æ¶ˆæ¯ä¸­ã€‚

7. Flowçš„è¿”å›æ¶ˆæ¯ç±»å‹æ˜¯Protobuf

## ç»“è¯­

Â Â Â Â åœ¨è¿™é‡Œä½ å¯èƒ½å·²ç»å‘ç°äº†æ–‡æ¡£ä¸­åªæœ‰ä¸€ä¸ªchunkï¼Œé‚£ä¹ˆå¦‚æœæœ‰å¤šä¸ªchunkæ—¶ï¼Œåº”è¯¥æ€ä¹ˆåšå‘¢ï¼Ÿè¯·çœ‹ä¸‹ä¸€ç¯‡ï¼Œ[JINA 3åˆ†é’Ÿå®ç°ä¸€å¥—æ–°é—»æœç´¢ç³»ç»Ÿ]()ã€‚
