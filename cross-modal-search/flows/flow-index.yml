jtype: Flow
version: '1'
with:
  prefetch: 10
pods:
  - name: loader
    uses: pods/image-load.yml
    shards: $JINA_PARALLEL
    read_only: true
  - name: normalizer
    uses: pods/image-normalize.yml
    shards: $JINA_PARALLEL
    read_only: true
  - name: image_encoder
    uses: pods/clip/image-encoder.yml
    shards: $JINA_PARALLEL
    timeout_ready: 600000
    read_only: true
  - name: image_vector_indexer
    polling: any
    uses: pods/index-image-vector.yml
    shards: $JINA_SHARDS
  - name: image_kv_indexer
    polling: any
    uses: pods/index-image-kv.yml
    shards: $JINA_SHARDS
    needs: [gateway]
  - name: text_encoder
    uses: pods/clip/text-encoder.yml
    uses_internal: $JINA_TEXT_ENCODER_INTERNAL
    shards: $JINA_PARALLEL
    timeout_ready: 600000
    read_only: true
    needs: [gateway]
  - name: text_indexer
    polling: any
    uses: pods/index-text.yml #(numpy + binary pb indexer)
    shards: $JINA_SHARDS
  - !NumpyIndexer
    with:
      index_filename: text_embs.gz
      metric: cosine
    metas:
      name: text_vec_idx  # a customized name
      py_modules: [ '../executors.py' ]
  - !BinaryPbIndexer
    with:
      index_filename: text.gz
    metas:
      name: text_kv_idx  # a customized name
      py_modules: [ '../executors.py' ]
#  - name: join_all
#    uses: _merge_root
#    needs: [image_vector_indexer, image_kv_indexer, text_indexer]
#    read_only: true
  - name: join_all
    uses: RootMerger
    metas:
      py_modules: [ '../executors.py' ]
    needs: [ image_vector_indexer, image_kv_indexer, text_indexer ]
    read_only: true